<!DOCTYPE html>
<html lang="zh">
    <head>
        <meta charset="UTF-8">
        <title>
            Python爬虫——zhihuSpider
        </title>
        <link rel="stylesheet" type="text/css" href="styleCode.css">
        <link rel="stylesheet" type="text/css" href="styleMod.css">
        <link rel="stylesheet" type="text/css" href="styleText.css">
    </head>
    <body>
        <div class="article">
            <div class="header">
                <div class="background-image">
                    <img src="https://pic1.zhimg.com/v2-59541c42f22cf31b935523d2a805a583_b.jpg" alt="background image">
                </div>
                <div class="title">
                    <a href="https://zhuanlan.zhihu.com/p/98811911" target="_blank">
                        Python爬虫——zhihuSpider
                    </a>
                </div>
                <a class="UserLink-link" target="_blank" href="https://www.zhihu.com/people/mo-gu-tang-37-71">
                    <div class="AuthorInfo">
                        <div class="Popover">
                            <img class="Avatar" width="50" height="50" src="https://pic1.zhimg.com/v2-5acda4303251954de40d222bad1e315d_l.jpg" alt="头像">
                        </div>
                        <div class="AuthorInfo-content">
                            <div class="AuthorInfo-name">
                                <span>
                                    蘑菇汤
                                </span>
                            </div>
                            <div class="AuthorInfo-detail">
                                <span>
                                    2019-12-23
                                </span>
                            </div>
                        </div>
                    </div>
                </a>
            </div>
            <div class="text">
                <p>
                    zhihuSpider是一个基于Python3的爬虫项目，它的功能不在于数据的大规模爬取，实际上也不支持大量爬取，其侧重点在于对爬取数据的展示。比如在浏览知乎时发现某些高质量的回答或者某些教程，希望把这些内容保存到本地，甚至是希望能打印出来，那么zhihuSpider就能派上用场。所以zhihuSpider是一款针对内容的爬虫。它利用知乎的一些PC端API获得内容数据，通过对数据进行解析最终输出HTML或markdown文件。
                </p>
                <p>
                    它的技术路线比较简单，很适合用来做爬虫及数据结构的练习。总体来说分成三个部分，即爬虫、解析生成HTML和解析生成markdown。
                </p>
                <h2>
                    爬虫部分
                </h2>
                <p>
                    知乎的内容，像回答、文章内容都是动态加载生成的，通过浏览器的开发工具很容易就能发现获取这些内容的API。程序对内容的爬取次数和爬取量非常少，每次运行发起1次或2次或22次网络请求，每次请求时间间隔5秒以上（休眠5秒），应该是最温柔的爬虫了吧。数据的获取由Python的requests库模仿浏览器对构造的API链接发起访问实现，请求后不出意外（偶尔需要验证）就能得到以json形式组织的数据。json数据中包含内容作者的昵称（网名）及以HTML标签形式组织的内容的主体。程序重点要处理的是内容的主体。
                </p>
                <p>
                    这里可能会有一个疑惑点，既然内容是以HTML的形式组织的，那为什么还要解析生成HTML？其实是因为有些复杂的内容样式标签不完整以及有些内容为了适应新的css样式而不得不进行修改。比如卡片式的链接，它的标签就不完整，不能像下面的卡片式链接展示的那样完美；而图片、视频，由于css样式方面的不同步，需要重新组织这部分内容。
                </p>
                <a target="_blank" href="https://zhuanlan.zhihu.com/p/98811911" class="LinkCard">
                    <span class="LinkCard-backdrop" style="background-image:url(https://zhstatic.zhihu.com/assets/zhihu/editor/zhihu-card-default.svg)">
                    </span>
                    <span class="LinkCard-content">
                        <span class="LinkCard-text">
                            <span class="LinkCard-title">
                                蘑菇汤：Python爬虫——zhihuSpider
                            </span>
                            <span class="LinkCard-meta">
                                <span style="display:inline-flex;align-items:center">
                                    ​
                                    <svg class="Zi Zi--InsertLink" fill="currentColor" viewBox="0 0 24 24" width="17" height="17">
                                        <path d="M6.77 17.23c-.905-.904-.94-2.333-.08-3.193l3.059-3.06-1.192-1.19-3.059 3.058c-1.489 1.489-1.427 3.954.138 5.519s4.03 1.627 5.519.138l3.059-3.059-1.192-1.192-3.059 3.06c-.86.86-2.289.824-3.193-.08zm3.016-8.673l1.192 1.192 3.059-3.06c.86-.86 2.289-.824 3.193.08.905.905.94 2.334.08 3.194l-3.059 3.06 1.192 1.19 3.059-3.058c1.489-1.489 1.427-3.954-.138-5.519s-4.03-1.627-5.519-.138L9.786 8.557zm-1.023 6.68c.33.33.863.343 1.177.029l5.34-5.34c.314-.314.3-.846-.03-1.176-.33-.33-.862-.344-1.176-.03l-5.34 5.34c-.314.314-.3.846.03 1.177z" rule="evenodd">
                                        </path>
                                    </svg>
                                </span>
                                zhuanlan.zhihu.com
                            </span>
                        </span>
                        <span class="LinkCard-imageCell">
                            <img class="LinkCard-image" alt="图标" src="https://zhstatic.zhihu.com/assets/zhihu/editor/zhihu-card-default.svg">
                        </span>
                    </span>
                </a>
                <h2>
                    解析生成HTML
                </h2>
                <p>
                    解析生成HTML标签的模块主要由四个核心的类，Tag、Paring、Mushroom、Compile构成，这四个类分别承担不同的工作。
                </p>
                <p>
                    Tag主要用于表示HTML标签，也能把字符串抽象为没有名字的标签；Paring类利用正则表达式对HTML标签进行解析生成一个个的Tag对象。同时这个类也承担解析HTML模板标签的工作，比方说上面提到的图片、视频内容要重新组织，这个类能把用于展示图片或视频的HTML标签模板解析成Tag对象，并把模板中的占位符替换成相应的图片、视频内容。
                </p>
                <p>
                    爬取的数据经过程序处理后会生成并输出HTML文件，Mushroom类承担在生成过程中管理HTML文件及辅助HTML文件的生成。
                </p>
                <p>
                    Compile类负责对解析后的HTML标签也就是Tag对象进行编辑，比如提取标签的核心信息，并将这些核心信息替换到HTML标签模板的占位符上，清除部分标签的属性使它适应新的css代码。
                </p>
                <h3>
                    Tag HTML标签的抽象
                </h3>
                <p>
                    Tag类能表示一个完整的HTML标签，包括标签的名称、标签内容、属性和属性值。其中标签内容除了一般性的字符串外，还可以是其他嵌套的标签。
                </p>
                <div class="highlight">
                    <pre><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">box</span><span class="p">&gt;&lt;</span><span class="nt">p</span><span class="p">&gt;</span>我们都是<span class="p">&lt;</span><span class="nt">strong</span><span class="p">&gt;</span>好孩子<span class="p">&lt;/</span><span class="nt">strong</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre>
                </div>
                <p>
                    观察上面的div标签，发现它由三部分构成：
                    <br>
                    <b>
                        start
                    </b>
                    :    起始标签，含属性(
                    <b>
                        class
                    </b>
                    )；
                    <br>
                    <b>
                        end
                    </b>
                    :      尾标签；
                    <br>
                    <b>
                        contents
                    </b>
                    :     内容，起止标签包围的内容，字符串或其他标签。
                    <br>
                    <br>
                    进一步观察发现，
                    <b>
                        p
                    </b>
                    标签和
                    <b>
                        strong
                    </b>
                    标签也是由上述三部分构成，只是这两个标签没有属性。为了统一化，把字符串也抽象成为一个没有名字和属性的特殊标签。
                </p>
                <div class="highlight">
                    <pre><span class="k">class</span> <span class="nc">Tag</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">attrs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">contents</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">string</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                 <span class="n">indent</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
        
        <span class="p">:</span><span class="n">param</span> <span class="n">name</span><span class="p">:</span> <span class="err">标签名称，如</span><span class="n">div</span>
        <span class="p">:</span><span class="n">param</span> <span class="n">attrs</span><span class="p">:</span> <span class="err">标签属性</span>
        <span class="p">:</span><span class="n">param</span> <span class="n">contents</span><span class="p">:</span> <span class="err">标签内容，一般通过</span><span class="o">.</span><span class="n">add</span><span class="p">()</span><span class="err">添加</span>
        <span class="p">:</span><span class="n">param</span> <span class="n">string</span><span class="p">:</span> <span class="err">字符串，用于创建名字为</span><span class="n">None的字符串标签</span><span class="err">，或者普通标签的字符串</span><span class="n">content</span>
        <span class="p">:</span><span class="n">param</span> <span class="n">indent</span><span class="p">:</span> <span class="o">.</span><span class="n">write</span><span class="err">（）时是否缩进，默认</span><span class="bp">True</span><span class="err">，主要用于</span><span class="o">&lt;</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="n">pre</span><span class="o">&gt;</span>
        
        <span class="k">pass</span>
</pre>
                </div>
                <h3>
                    Paring HTML标签的解析
                </h3>
                <p>
                    Paring类原本是一个函数，为了提供更多的功能和便于理解代码含义就把它改成了一个类。它一共有两个可供外部调用的方法，分别用于解析一般性的HTML标签和用于解析HTML标签模板，它的工作模式有点类似于加工厂，每次解析完标签数据后就会恢复到初始化状态。
                </p>
                <div class="highlight">
                    <pre><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">video</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">__video-link__</span> <span class="na">target</span><span class="o">=</span><span class="s">_blank</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">video-cover</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="o">=</span><span class="s">__video-cover__</span> <span class="na">alt</span><span class="o">=</span><span class="s">video</span> <span class="na">cover</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">video-tip</span> <span class="na">TipCard</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">TipCard-backdrop</span> <span class="na">style</span><span class="o">=</span><span class="s">background-image:url(__video-cover__)</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">span</span> <span class="na">style</span><span class="o">=</span><span class="s">font-size:18px;color:#222;line-height:34px;display:block;</span><span class="p">&gt;</span>__video-tip__<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre>
                </div>
                <p>
                    <br>
                </p>
                <h3>
                    解析原理
                </h3>
                <p>
                    观察上面两段HTML代码，不论简单还是复杂的标签，它一般都由
                    <b>
                        起始标签
                    </b>
                    、
                    <b>
                        尾标签
                    </b>
                    和
                    <b>
                        内容
                    </b>
                    三部分共同构成。把它们压缩到一行（参考C语言中字符串在内存的表示方式），从左向右扫描，一旦发现这是一个起始标签，就提取它的名称和属性构造一个Tag对象，继续向右扫描，不论发现什么，它们都是这个标签的内容，将添加到标签的contents，直到扫描发现尾标签。
                </p>
                <p>
                    起止标签包围的内容都归它所有，被它“接收”。同样，它包含的子标签也需要“接收”自身的内容，直到出现尾标签。
                </p>
                <p>
                    因此需要一个栈来暂时存放标签，往后的内容都归处于栈顶的标签“接收”，发现子标签后，子标签被压入栈顶，直到尾标签出现，栈顶出栈。原来的栈顶，也就是子标签的父级标签再次成为新栈顶继续“接收”它的内容。
                </p>
                <p>
                    创建一个栈，从左向右扫描HTML，一旦发现是起始标签就创建这个标签，并让它入栈“接收”内容，继续向下扫描，如果发现新的标签就添加到栈顶contents，同时让它入栈，如果是字符串，它必定被栈顶标签包围，并且没有content可接收，直接添加到栈顶contents。每扫描到一个尾标签，就让栈顶出栈。
                </p>
                <p>
                    这种解析方式要求HTML标签必须拥有完整起止标签，缺失起止标签都将导致内容“接收”出现混乱（结构混乱），过多或过少接收。没有起始标签，它的尾标签将导致栈顶标签提前弹出；缺失尾标签，其将滞后甚至不弹出栈顶。
                </p>
                <h2>
                    解析生成markdown
                </h2>
                <p>
                    知乎内容主体的格式不是很复杂，使用markdown也基本能保留原文的样式。HTML转markdown主要依靠两者的样式来实现。这个模块的代码实现相比解析生成HTML模块要复杂一些，而且实现方式不是很优雅，这里就不做过多的解析，有兴趣的同学可以自己研究源码。
                </p>
                <p>
                    这个模块是今年5月份实现的，当时还没有开发出HTML的解析类，所以使用的是BeautifulSoup类解析。
                </p>
                <p>
                    HTML可以用一棵多叉树来表示层级结构。多叉，具体是多少由HTML的标签结构来确定。整体样式像下方图片展示的那样。
                </p>
                <figure>
                    <img src="https://pic3.zhimg.com/v2-c3e7ca00a9e9a379bee000082feaf68a_r.gif">
                </figure>
                <p>
                    用链表的形式，由父节点指向子节点实现多叉树，会因为子节点的数量不确定而变得麻烦。转变一下思维，每个节点有两个指针，一个指向下一个兄弟节点，一个指向第一个子节点，依次类推就能用类似于二叉树的结构实现多叉树，如下图所示。
                </p>
                <figure>
                    <img src="https://pic2.zhimg.com/v2-95445f58eb20622ba77e74b795278589_r.gif">
                </figure>
                <p>
                    md模块用于解析生成markdown文件。像figure这种能直接提取重要信息而后向markdown转换的标签，在程序中用继承了Simple的类来处理，这类标签不需要继续向下解析。
                </p>
                <p>
                    像p、blockquote这类可能包含有strong、a等标签的父级标签就不能直接提取信息向markdown转换，需要递归向下逐步解析，它们由继承了Multilevel的类来处理。
                </p>
                <p>
                    Multilevel类继承了Simple类，实际上Simple类还是一棵多叉树的节点，有next_sibling和child两个指针。多叉树的生成代码在Multilevel类的构造方法中，所有继承了Multilevel类的子类都能把自己添加到这棵多叉树中。
                </p>
                <p>
                    md模块使用了隐形的多叉树结构和隐式递归使得在结构上比较混乱，难以理解。它的重构思路将参考html模块的实现，把处理各种标签的类改成函数，用一个大类来统领。使用清晰的多叉树结构和显式递归。
                </p>
                <p>
                    html模块的Tag类也使用了多叉树结构，它用列表来容纳不定量的子节点，列表内的节点之间构成兄弟关系。
                </p>
                <h2>
                    Config 全局配置管理器
                </h2>
                <p>
                    程序在运行过程中用到的数据、设置信息都可以由Config提供，包括HTML标签模板，API链接（这部分已经删除）、程序设置等。Config会在程序启动时手动或自动初始化，整个运行过程只初始化一次。
                </p>
                <h2>
                    内容样式
                </h2>
                <p>
                    在排版样式上不论markdown还是HTML都基本保留了知乎的风格。其中HTML增加了首行缩进两字符，题头的排版参考了知乎、markdown和某些博客。
                </p>
                <p>
                    文章的标题和作者昵称分别链接了原文和作者主页。
                </p>
                <figure>
                    <img src="https://pic2.zhimg.com/v2-d724137ed7a90ecb55c261e33df3a871_r.gif">
                </figure>
                <figure>
                    <img src="https://pic2.zhimg.com/v2-94097835e322f7c6dba9d2747fb1daad_r.gif">
                </figure>
                <h2>
                    项目
                </h2>
                <p>
                    项目目前已经在GitHub开源，为了不对网站造成影响，API部分已经删除，但代码结构完整，只是删除了config文件中关于API的部分。待文章发表后，会提供这篇文章的json数据以供参考。
                </p>
                <a target="_blank" href="https://link.zhihu.com/?target=https%3A//github.com/Milloyy/ZhihuSpider" class="LinkCard">
                    <span class="LinkCard-backdrop" style="background-image:url(https://pic1.zhimg.com/v2-7fcc128602ed695a79f6cab690de072c_ipico.jpg)">
                    </span>
                    <span class="LinkCard-content">
                        <span class="LinkCard-text">
                            <span class="LinkCard-title">
                                Milloyy/ZhihuSpider
                            </span>
                            <span class="LinkCard-meta">
                                <span style="display:inline-flex;align-items:center">
                                    ​
                                    <svg class="Zi Zi--InsertLink" fill="currentColor" viewBox="0 0 24 24" width="17" height="17">
                                        <path d="M6.77 17.23c-.905-.904-.94-2.333-.08-3.193l3.059-3.06-1.192-1.19-3.059 3.058c-1.489 1.489-1.427 3.954.138 5.519s4.03 1.627 5.519.138l3.059-3.059-1.192-1.192-3.059 3.06c-.86.86-2.289.824-3.193-.08zm3.016-8.673l1.192 1.192 3.059-3.06c.86-.86 2.289-.824 3.193.08.905.905.94 2.334.08 3.194l-3.059 3.06 1.192 1.19 3.059-3.058c1.489-1.489 1.427-3.954-.138-5.519s-4.03-1.627-5.519-.138L9.786 8.557zm-1.023 6.68c.33.33.863.343 1.177.029l5.34-5.34c.314-.314.3-.846-.03-1.176-.33-.33-.862-.344-1.176-.03l-5.34 5.34c-.314.314-.3.846.03 1.177z" rule="evenodd">
                                        </path>
                                    </svg>
                                </span>
                                github.com
                            </span>
                        </span>
                        <span class="LinkCard-imageCell">
                            <img class="LinkCard-image" alt="图标" src="https://pic1.zhimg.com/v2-7fcc128602ed695a79f6cab690de072c_ipico.jpg">
                        </span>
                    </span>
                </a>
                <p>
                </p>
            </div>
        </div>
    </body>
</html>
